<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Fact Atlas | Explore World Trivia</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        :root {
            --bg-color: #0f172a;
            --text-color: #f8fafc;
            --panel-bg: rgba(15, 23, 42, 0.95);
            --accent: #38bdf8;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        [data-theme="light"] {
            --bg-color: #f8fafc;
            --text-color: #0f172a;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --accent: #0284c7;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: var(--text-color); }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* --- NAVIGATION BAR (NEW REQUIREMENT) --- */
        .navbar {
            position: absolute; top: 20px; right: 20px; z-index: 2;
            display: flex; gap: 10px; align-items: center;
            background: var(--panel-bg); padding: 10px 15px; border-radius: 12px;
            box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.1);
        }
        .nav-link { color: var(--text-color); text-decoration: none; font-size: 0.9rem; font-weight: 600; margin: 0 8px; }
        .nav-link:hover { color: var(--accent); }

        /* --- UI PANEL --- */
        .ui-container {
            position: absolute; top: 20px; left: 20px; 
            width: 450px; max-width: 90%; z-index: 1;
            display: flex; flex-direction: column; gap: 15px;
            max-height: 90vh; overflow-y: auto; /* Allow scrolling if content is long */
        }

        .panel {
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.1);
        }

        h1 { margin: 0 0 5px 0; font-size: 1.5rem; letter-spacing: -0.5px; }
        .subtitle { font-size: 0.85rem; opacity: 0.8; margin-bottom: 20px; display: block; line-height: 1.5;}

        /* --- STATIC CONTENT SECTION (FOR CRAWLERS) --- */
        .static-content h3 { font-size: 1rem; color: var(--accent); margin-top: 0; }
        .static-fact { font-size: 0.9rem; margin-bottom: 15px; border-left: 3px solid var(--accent); padding-left: 10px; }

        /* --- DYNAMIC FACT AREA --- */
        #dynamic-area { display: none; } /* Hidden until first click */
        p#fact-text { line-height: 1.6; font-size: 1.05rem; margin-bottom: 15px; min-height: 80px; }
        .location-name { font-weight: bold; color: var(--accent); text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; display: block; margin-bottom: 5px;}

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button.action-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.1s;
        }
        button.action-btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: rgba(128,128,128,0.2); color: var(--text-color); }

        .theme-toggle { cursor: pointer; background: none; border: none; font-size: 1.2rem; margin-left: 10px; }

        @media (max-width: 600px) {
            .navbar { top: auto; bottom: 20px; right: 20px; left: 20px; justify-content: center; }
            .ui-container { top: 20px; left: 20px; right: 20px; width: auto; }
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="navbar">
        <a href="about.html" class="nav-link">About</a>
        <a href="privacy.html" class="nav-link">Privacy</a>
        <select id="lang-select" onchange="changeLanguage()" style="background:transparent; color:inherit; border:none; outline:none; font-weight:bold; cursor:pointer;">
            <option value="English">ðŸ‡¬ðŸ‡§ EN</option>
            <option value="Spanish">ðŸ‡ªðŸ‡¸ ES</option>
            <option value="French">ðŸ‡«ðŸ‡· FR</option>
            <option value="German">ðŸ‡©ðŸ‡ª DE</option>
        </select>
        <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ—</button>
    </div>

    <div class="ui-container">
        <div class="panel">
            <h1>Random Fact Atlas</h1>
            <span class="subtitle">An interactive 3D guide to world history, geography, and trivia. Spin the globe to discover the secrets of our planet.</span>
            
            <div id="static-welcome">
                <div class="static-content">
                    <h3>Did you know?</h3>
                    <div class="static-fact">
                        <strong>Tokyo, Japan:</strong> Tokyo was originally a small fishing village named Edo. It wasn't until 1868, when the Emperor moved there from Kyoto, that it was renamed Tokyo, meaning "Eastern Capital."
                    </div>
                    <div class="static-fact">
                        <strong>Cairo, Egypt:</strong> The Great Pyramid of Giza was the tallest man-made structure in the world for over 3,800 years until the Lincoln Cathedral was built in England in 1311.
                    </div>
                    <p style="font-size: 0.8rem; opacity: 0.8;">Click "Surprise Me" or tap anywhere on the map to generate a new fact.</p>
                </div>
            </div>

            <div id="dynamic-area">
                <span class="location-name" id="location-name-dynamic">Location</span>
                <p id="fact-text"></p>
                <a id="source-link" href="#" target="_blank" style="color: var(--accent); font-size: 0.8rem;">ðŸ”Ž Verify this fact</a>
            </div>

            <div class="btn-group">
                <button class="action-btn btn-primary" onclick="flyToRandom()">Surprise Me</button>
                <button class="action-btn btn-secondary" onclick="refreshFact()">New Fact</button>
            </div>
        </div>
    </div>

    <div id="cookie-banner" style="display:none; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(15, 23, 42, 0.95); color: white; padding: 15px; z-index: 9999; text-align: center; border-top: 1px solid #38bdf8;">
        <p style="margin: 0 0 10px 0; font-size: 0.9rem;">
            We use cookies to personalize content. <a href="privacy.html" style="color: #38bdf8;">Privacy Policy</a>.
        </p>
        <button id="accept-cookies" style="background: #38bdf8; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">I Accept</button>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGlzY291bnRkZXYiLCJhIjoiY21pOHRnbWl6MDNtajJrcTA0M250ZjFpeiJ9.IQHxOtZGRv3VEz_Ifv1v4w'; 

        let currentTheme = 'dark';
        let currentLocation = null;

        const majorCities = [
            {name: "New York, USA", lng: -74.0060, lat: 40.7128},
            {name: "Tokyo, Japan", lng: 139.6917, lat: 35.6895},
            {name: "London, UK", lng: -0.1276, lat: 51.5074},
            {name: "Paris, France", lng: 2.3522, lat: 48.8566},
            {name: "Cairo, Egypt", lng: 31.2357, lat: 30.0444}
        ];

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            projection: 'globe',
            zoom: 1.5,
            center: [-30, 20]
        });

        map.on('style.load', () => {
            map.setFog({ 'color': 'rgb(186, 210, 235)', 'high-color': 'rgb(36, 92, 223)', 'horizon-blend': 0.02, 'space-color': 'rgb(11, 11, 25)', 'star-intensity': 0.6 });
        });

        // --- INTERACTION ---
        function switchToDynamicView() {
            document.getElementById('static-welcome').style.display = 'none';
            document.getElementById('dynamic-area').style.display = 'block';
        }

        map.on('click', async (e) => {
            switchToDynamicView();
            const { lng, lat } = e.lngLat;
            handleLocationSelect(lng, lat);
        });

        async function handleLocationSelect(lng, lat) {
            document.getElementById('fact-text').innerText = "Locating...";
            document.getElementById('source-link').style.display = 'none';
            
            map.flyTo({ center: [lng, lat], zoom: 4, essential: true });

            try {
                const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?types=place,locality&access_token=${mapboxgl.accessToken}`);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    const placeName = data.features[0].text; 
                    const fullName = data.features[0].place_name;
                    currentLocation = { name: placeName, lat: lat, lng: lng };
                    
                    document.getElementById('location-name-dynamic').innerText = fullName;
                    fetchAiFact(placeName, lat, lng);
                } else {
                    document.getElementById('location-name-dynamic').innerText = "Unknown Location";
                    document.getElementById('fact-text').innerText = "You clicked on a very remote spot! Try clicking closer to a city.";
                    currentLocation = null;
                }
            } catch (error) { console.error(error); }
        }

        async function fetchAiFact(city, lat, lng) {
            const statusText = document.getElementById('fact-text');
            const selectedLang = document.getElementById('lang-select').value;
            statusText.innerText = "Consulting the Atlas...";
            
            try {
                const response = await fetch('/.netlify/functions/get-fact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ city, lat, lng, language: selectedLang })
                });
                
                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                const jsonStart = aiText.indexOf('{');
                const jsonEnd = aiText.lastIndexOf('}');
                
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    const factData = JSON.parse(aiText.substring(jsonStart, jsonEnd + 1));
                    statusText.innerText = factData.text;
                    const sourceLink = document.getElementById('source-link');
                    if (factData.source_term) {
                        sourceLink.href = `https://www.google.com/search?q=${encodeURIComponent(factData.source_term)}`;
                        sourceLink.style.display = 'inline-block';
                    }
                }
            } catch (error) {
                statusText.innerText = "The AI is thinking too hard. Try another spot.";
            }
        }

        function refreshFact() {
            if (currentLocation) {
                fetchAiFact(currentLocation.name, currentLocation.lat, currentLocation.lng);
            } else {
                flyToRandom();
            }
        }

        function changeLanguage() {
            if (currentLocation) refreshFact();
        }

        function flyToRandom() {
            switchToDynamicView();
            const randomCity = majorCities[Math.floor(Math.random() * majorCities.length)];
            handleLocationSelect(randomCity.lng, randomCity.lat);
        }

        function toggleTheme() {
            const root = document.documentElement;
            if (currentTheme === 'dark') {
                currentTheme = 'light';
                root.setAttribute('data-theme', 'light');
                map.setStyle('mapbox://styles/mapbox/streets-v12'); 
            } else {
                currentTheme = 'dark';
                root.setAttribute('data-theme', 'dark');
                map.setStyle('mapbox://styles/mapbox/satellite-streets-v12'); 
            }
        }

        // Cookie Banner
        if (!localStorage.getItem('cookiesAccepted')) {
            document.getElementById('cookie-banner').style.display = 'block';
        }
        document.getElementById('accept-cookies').addEventListener('click', function() {
            localStorage.setItem('cookiesAccepted', 'true');
            document.getElementById('cookie-banner').style.display = 'none';
        });
    </script>
</body>
</html>

