<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JQ346WNXC3"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-JQ346WNXC3');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Fact Atlas | Explore the World</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        :root {
            --bg-color: #0f172a;
            --text-color: #f8fafc;
            --panel-bg: rgba(15, 23, 42, 0.95);
            --accent: #38bdf8;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        [data-theme="light"] {
            --bg-color: #f8fafc;
            --text-color: #0f172a;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --accent: #0284c7;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: var(--text-color); }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* --- TOP RIGHT CONTROLS --- */
        .top-controls {
            position: absolute; top: 20px; right: 20px; z-index: 2;
            display: flex; gap: 10px; align-items: center;
        }

        .control-btn, select {
            background: var(--panel-bg); color: var(--text-color);
            border: 1px solid rgba(128,128,128,0.3);
            padding: 8px 12px; border-radius: 8px;
            backdrop-filter: blur(10px); cursor: pointer;
            font-family: inherit; font-size: 0.9rem;
            box-shadow: var(--shadow);
            outline: none;
        }
        
        .control-btn:hover { opacity: 0.9; }

        /* --- UI PANEL --- */
        .ui-container {
            position: absolute; top: 20px; left: 20px; width: 400px; max-width: 90%; z-index: 1;
            display: flex; flex-direction: column; gap: 15px;
        }

        .panel {
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            padding: 25px; /* Larger padding */
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        h1 { margin: 0 0 5px 0; font-size: 1.6rem; letter-spacing: -0.5px; }
        .subtitle { font-size: 0.8rem; opacity: 0.7; margin-bottom: 15px; display: block;}

        /* Larger Text for Facts */
        p#fact-text { 
            line-height: 1.6; 
            font-size: 1.05rem; /* Increased size */
            margin-bottom: 15px; 
            min-height: 80px; 
        }
        
        .location-name { font-weight: bold; color: var(--accent); text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; display: block; margin-bottom: 5px;}

        .source-link {
            display: inline-block; font-size: 0.8rem; color: var(--accent);
            text-decoration: none; border-bottom: 1px dotted var(--accent);
            margin-bottom: 15px; cursor: pointer;
        }
        .source-link:hover { opacity: 0.8; }

        .btn-group { display: flex; gap: 10px; margin-top: 5px; }
        button.action-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.1s;
        }
        button.action-btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: rgba(128,128,128,0.2); color: var(--text-color); }

        /* --- AD BANNER --- */
        .ad-banner {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 728px; height: 90px; background: rgba(0,0,0,0.2);
            border: 1px dashed var(--text-color); display: flex; align-items: center;
            justify-content: center; font-size: 0.8rem; opacity: 0.6; border-radius: 8px; z-index: 1;
        }

        /* --- ABOUT MODAL (CRITICAL FOR ADSENSE) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 999;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--bg-color); padding: 30px; border-radius: 12px;
            max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
            position: relative; line-height: 1.7;
        }
        .close-modal { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.5rem; border:none; background:none; color: var(--text-color);}

        @media (max-width: 600px) {
            .ad-banner { width: 300px; height: 50px; }
            .ui-container { width: auto; right: 20px; }
            .top-controls { flex-wrap: wrap; justify-content: flex-end; }
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="top-controls">
        <select id="lang-select" onchange="changeLanguage()">
            <option value="English">üá¨üáß English</option>
            <option value="Spanish">üá™üá∏ Espa√±ol</option>
            <option value="French">üá´üá∑ Fran√ßais</option>
            <option value="German">üá©üá™ Deutsch</option>
            <option value="Japanese">üáØüáµ Êó•Êú¨Ë™û</option>
            <option value="Portuguese">üáßüá∑ Portugu√™s</option>
            <option value="Italian">üáÆüáπ Italiano</option>
        </select>
        
        <button class="control-btn" onclick="openModal('aboutModal')">‚ÑπÔ∏è About</button>
        
        <button class="control-btn" onclick="toggleTheme()">üåó</button>
    </div>

    <div class="ui-container">
        <div class="panel">
            <h1>Random Fact Atlas</h1>
            <span class="subtitle">Explore the hidden history of the world.</span>
            
            <div id="content-area">
                <span class="location-name">Welcome</span>
                <p id="fact-text">Spin the globe and click any city to discover its secrets, or let fate decide.</p>
                <a id="source-link" class="source-link" href="#" target="_blank" style="display:none;">üîé Verify this fact</a>
            </div>

            <div class="btn-group">
                <button class="action-btn btn-primary" onclick="flyToRandom()">Surprise Me</button>
                <button class="action-btn btn-secondary" id="btn-new-fact" onclick="refreshFact()">New Fact</button>
            </div>

            <div style="margin-top: 15px; font-size: 0.75rem; text-align: center; opacity: 0.6;">
                <a href="privacy.html" style="color: inherit; text-decoration: none;">Privacy Policy</a>
            </div>
        </div>
    </div>

    <div class="ad-banner">
        Google AdSense Banner
    </div>

    <div class="modal-overlay" id="aboutModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('aboutModal')">&times;</button>
            <h2>About Random Fact Atlas</h2>
            <p>Welcome to the ultimate tool for curious minds. Random Fact Atlas is an interactive educational platform designed to make geography and history accessible to everyone.</p>
            <h3>How It Works</h3>
            <p>Our platform combines advanced 3D mapping technology with Generative AI to deliver unique, verified trivia about any location on Earth. Whether you are a student, a traveler, or just exploring from home, our tool provides deep insights into the culture, history, and geography of our planet.</p>
            <h3>Features</h3>
            <ul>
                <li><strong>AI-Powered Insights:</strong> Every fact is generated in real-time, ensuring you never run out of new things to learn.</li>
                <li><strong>Global Coverage:</strong> From major capitals to remote villages, our map covers the entire globe.</li>
                <li><strong>Multi-Language Support:</strong> Learn in your native language with our built-in translation engine.</li>
            </ul>
            <p>We are committed to providing a free, accessible learning resource for the world.</p>
        </div>
    </div>

    <div id="cookie-banner" style="display:none; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(15, 23, 42, 0.95); color: white; padding: 15px; z-index: 9999; text-align: center; border-top: 1px solid #38bdf8;">
        <p style="margin: 0 0 10px 0; font-size: 0.9rem;">
            We use cookies to personalize content and ads. By using our site, you consent to our <a href="privacy.html" style="color: #38bdf8;">Privacy Policy</a>.
        </p>
        <button id="accept-cookies" style="background: #38bdf8; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">I Accept</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGlzY291bnRkZXYiLCJhIjoiY21pOHRnbWl6MDNtajJrcTA0M250ZjFpeiJ9.IQHxOtZGRv3VEz_Ifv1v4w'; 

        let currentTheme = 'dark';
        let currentLocation = null; // Object: {name, lat, lng}
        let currentMarker = null; 

        const majorCities = [
            {name: "New York, USA", lng: -74.0060, lat: 40.7128},
            {name: "Tokyo, Japan", lng: 139.6917, lat: 35.6895},
            {name: "London, UK", lng: -0.1276, lat: 51.5074},
            {name: "Paris, France", lng: 2.3522, lat: 48.8566},
            {name: "Cairo, Egypt", lng: 31.2357, lat: 30.0444},
            {name: "Sydney, Australia", lng: 151.2093, lat: -33.8688},
            {name: "Rio de Janeiro, Brazil", lng: -43.1729, lat: -22.9068}
        ];

        // --- MAP INIT ---
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            projection: 'globe',
            zoom: 1.5,
            center: [-30, 20]
        });

        map.on('style.load', () => {
            map.setFog({
                'color': 'rgb(186, 210, 235)', 'high-color': 'rgb(36, 92, 223)', 
                'horizon-blend': 0.02, 'space-color': 'rgb(11, 11, 25)', 'star-intensity': 0.6 
            });
        });

        // --- INTERACTION ---
        map.on('click', async (e) => {
            const { lng, lat } = e.lngLat;
            dropPin(lng, lat);
            handleLocationSelect(lng, lat);
        });

        function dropPin(lng, lat) {
            if (currentMarker) currentMarker.remove();
            currentMarker = new mapboxgl.Marker({ color: "#FF4444" }).setLngLat([lng, lat]).addTo(map);
        }

        async function handleLocationSelect(lng, lat) {
            // UI Reset
            document.getElementById('fact-text').innerText = "Locating...";
            document.getElementById('source-link').style.display = 'none';
            
            map.flyTo({ center: [lng, lat], zoom: 4, essential: true });

            try {
                const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?types=place,locality&access_token=${mapboxgl.accessToken}`);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    const placeName = data.features[0].text; 
                    const fullName = data.features[0].place_name;
                    
                    // Save for "New Fact" button
                    currentLocation = { name: placeName, lat: lat, lng: lng };
                    
                    document.querySelector('.location-name').innerText = fullName;
                    
                    // Call Backend
                    fetchAiFact(placeName, lat, lng);
                } else {
                    document.querySelector('.location-name').innerText = "Unknown Location";
                    document.getElementById('fact-text').innerText = "You clicked on a very remote spot! No cities found here.";
                    currentLocation = null;
                }
            } catch (error) {
                console.error(error);
            }
        }

        // --- BACKEND CALL (MODIFIED FOR SINGLE FACT + LANGUAGE) ---
        async function fetchAiFact(city, lat, lng) {
            const statusText = document.getElementById('fact-text');
            const selectedLang = document.getElementById('lang-select').value;
            
            statusText.innerText = "Consulting the Atlas...";
            
            const url = '/.netlify/functions/get-fact'; 
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Send Language!
                    body: JSON.stringify({ city, lat, lng, language: selectedLang })
                });

                if (!response.ok) throw new Error("Backend Error");

                const data = await response.json();
                
                // Parse AI Output (Now expecting a Single Object, not an Array)
                const aiText = data.candidates[0].content.parts[0].text;
                
                // Regex to find the JSON object { ... }
                const jsonStart = aiText.indexOf('{');
                const jsonEnd = aiText.lastIndexOf('}');
                
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    const factData = JSON.parse(aiText.substring(jsonStart, jsonEnd + 1));
                    
                    // Display Fact
                    statusText.innerText = factData.text;
                    
                    // Update Source Link
                    const sourceLink = document.getElementById('source-link');
                    if (factData.source_term) {
                        sourceLink.href = `https://www.google.com/search?q=${encodeURIComponent(factData.source_term)}`;
                        sourceLink.style.display = 'inline-block';
                    }
                } else {
                    throw new Error("Invalid AI format");
                }

            } catch (error) {
                console.error(error);
                statusText.innerText = "The AI is thinking too hard. Try another spot.";
            }
        }

        // --- BUTTONS ---
        function refreshFact() {
            if (currentLocation) {
                // Just call the API again! The AI is random enough to give a new fact.
                fetchAiFact(currentLocation.name, currentLocation.lat, currentLocation.lng);
            } else {
                flyToRandom();
            }
        }
        
        function changeLanguage() {
            // If we are already looking at a city, refresh the fact in the new language
            if (currentLocation) {
                refreshFact();
            }
        }

        function flyToRandom() {
            const randomCity = majorCities[Math.floor(Math.random() * majorCities.length)];
            dropPin(randomCity.lng, randomCity.lat);
            handleLocationSelect(randomCity.lng, randomCity.lat);
        }

        function toggleTheme() {
            const root = document.documentElement;
            if (currentTheme === 'dark') {
                currentTheme = 'light';
                root.setAttribute('data-theme', 'light');
                map.setStyle('mapbox://styles/mapbox/streets-v12'); 
            } else {
                currentTheme = 'dark';
                root.setAttribute('data-theme', 'dark');
                map.setStyle('mapbox://styles/mapbox/satellite-streets-v12'); 
            }
        }

        // --- MODALS ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- COOKIES ---
        if (!localStorage.getItem('cookiesAccepted')) {
            document.getElementById('cookie-banner').style.display = 'block';
        }
        document.getElementById('accept-cookies').addEventListener('click', function() {
            localStorage.setItem('cookiesAccepted', 'true');
            document.getElementById('cookie-banner').style.display = 'none';
        });

    </script>
</body>
</html>